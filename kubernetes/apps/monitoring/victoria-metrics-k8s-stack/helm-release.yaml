---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-metrics-k8s-stack
  namespace: monitoring
spec:
  interval: 5m
  upgrade:
    force: true
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      version: 0.62.2
      sourceRef:
        kind: HelmRepository
        name: victoria-metrics
        namespace: flux-system
      interval: 5m
  values:
    victoria-metrics-operator:
      enabled: false

    prometheus-node-exporter:
      enabled: false

    grafana:
      ingress:
        enabled: true
        hosts:
          - "grafana.${domain}"

      # This is currently breaking sops substitution with `client_secret`
      # Maybe a need to consider changing my approach
      assertNoLeakedSecrets: false

      grafana.ini:
        server:
          domain: "grafana.${domain}"
          root_url: "https://grafana.${domain}"
        auth.generic_oauth:
          enabled: true
          name: Authelia
          client_id: grafana
          client_secret: ${authelia_grafana_client_secret}
          auth_url: https://login.${domain}/api/oidc/authorization
          token_url: https://login.${domain}/api/oidc/token
          api_url: https://login.${domain}/api/oidc/userinfo
          scopes: "openid profile groups email"
          login_attribute_path: preferred_username
          name_attribute_path: name
          groups_attribute_path: groups
          use_pkce: true
          role_attribute_path: "contains(groups, 'admin') && 'Admin' || contains(groups, 'editor') && 'Editor' || 'Viewer'"

    vmsingle:
      ingress:
        enabled: true
        annotations:
          traefik.ingress.kubernetes.io/router.middlewares: "admin-forwardauth-authelia@kubernetescrd"
        hosts:
          - "vm.${domain}"
